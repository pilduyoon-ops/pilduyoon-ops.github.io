<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ben P. Miller: Creative Flow Defense</title>
    <script src="https://w.soundcloud.com/player/api.js"></script>
    <style>
        body {
            margin: 0;
            background: linear-gradient(to bottom, #0f0c29, #302b63);
            overflow: hidden;
            font-family: 'Segoe UI', sans-serif;
            user-select: none;
        }
        canvas { display: block; cursor: none; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }

        .hud-bar {
            position: absolute; top: 0; left: 0; width: 100%;
            display: flex; justify-content: space-between;
            padding: 20px 40px; box-sizing: border-box;
            color: #e0ffe0; font-weight: 900; font-size: 24px;
            text-shadow: 0 0 10px #00ff00;
        }

        /* Ï§ëÏïô Î©îÎâ¥ */
        .menu-box {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(5, 15, 5, 0.95);
            padding: 40px 60px;
            border-radius: 20px;
            border: 3px solid #4CAF50;
            box-shadow: 0 0 60px rgba(0, 255, 0, 0.2);
            pointer-events: auto;
            color: white;
            min-width: 450px;
        }
        
        .menu-box h1 { color: #4CAF50; font-size: 36px; margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 2px;}
        .menu-box p { color: #bbb; margin-bottom: 25px; font-size: 16px; line-height: 1.5; }
        
        .item-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; 
            text-align: left; margin-bottom: 30px; font-size: 14px; color: #ccc;
        }
        .item-row { display: flex; align-items: center; gap: 10px; }
        .icon { font-size: 20px; width: 30px; text-align: center; }

        .btn {
            background: linear-gradient(#43A047, #2E7D32);
            border: none; border-radius: 4px;
            padding: 12px 40px; color: white; font-size: 20px; font-weight: bold;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: transform 0.1s;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .btn:active { transform: scale(0.96); }

        #status-msg {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            font-size: 50px; font-weight: 900;
            text-shadow: 0 0 30px currentColor; display: none;
            z-index: 20; letter-spacing: 2px; white-space: nowrap;
        }

        /* BGM Controller (creativeflow style) */
        #music-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background-color: rgba(30, 30, 30, 0.8);
            border: 2px solid #4CAF50;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            pointer-events: auto;
            z-index: 25;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        #music-btn:hover {
            transform: scale(1.1);
            background-color: #4CAF50;
        }

        #music-btn.music-playing {
            background-color: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }

        #music-btn svg {
            width: 24px;
            height: 24px;
            fill: #fff;
        }

        #sc-widget { display: none; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="hud-bar">
            <div>FLOW: <span id="score">0</span></div>
            </div>

        <div id="status-msg">WAVE!</div>

        <div id="start-screen" class="menu-box">
            <h1>Creative Flow</h1>
            <p style="margin-bottom: 15px; line-height: 1.7;">
                Become <strong>Ben P. Miller</strong> and defend your creative focus!<br>
                <span style="font-size: 14px; color: #aaa;">
                Avoid the red jagged distractions and collect power-ups to maximize your FLOW score.
                </span>
            </p>

            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px; font-size: 13px; text-align: left;">
                <strong style="color: #4CAF50;">üì± Controls:</strong><br>
                üñ±Ô∏è Desktop: Move with mouse<br>
                üì± Mobile: Tilt device to move
            </div>

            <div style="font-size: 13px; color: #ccc; margin-bottom: 15px; text-align: left;">
                <strong style="color: #4CAF50;">üéØ Power-Ups:</strong>
            </div>
            <div class="item-grid">
                <div class="item-row"><span class="icon">üíø</span> Vinyl Shooter</div>
                <div class="item-row"><span class="icon">üéµ</span> Melody Orbit</div>
                <div class="item-row"><span class="icon" style="color:#ffff00">‚ö°</span> Laser Beam</div>
                <div class="item-row"><span class="icon">üéπ</span> Piano Road</div>
                <div class="item-row"><span class="icon" style="color:#00ffaa">üõ°Ô∏è</span> Force Field</div>
                <div class="item-row"><span class="icon">üìÄ</span> Sound Ball</div>
                <div class="item-row"><span class="icon">üì∂</span> Power Chord</div>
                <div class="item-row"><span class="icon">üí£</span> Bass Drop</div>
            </div>
            <button class="btn" onclick="startGame()">Start Session</button>
        </div>

        <div id="game-over-screen" class="menu-box" style="display:none;">
            <h1 style="color:#ff5555;">FOCUS LOST</h1>
            <p>Overwhelmed by distractions!<br>Final Score: <span id="final-score" style="font-weight:bold; color:#fff;">0</span></p>

            <input type="text" id="player-name" placeholder="Enter your name" style="padding:10px; font-size:1.2rem; text-align:center; border:2px solid #4CAF50; background:transparent; color:white; border-radius:10px; margin-bottom:15px; outline:none; width:250px;">
            <br>

            <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
                <button class="btn" onclick="saveAndPlayAgain()" style="padding:12px 20px; font-size:16px; background:linear-gradient(#43A047, #2E7D32);">üíæ Save & Play Again</button>
                <button class="btn" onclick="startGame()" style="padding:12px 20px; font-size:16px; background:linear-gradient(#1976D2, #0D47A1);">üîÑ Play Again</button>
            </div>

            <div id="rank-box" style="margin-top:20px; background:rgba(255,255,255,0.1); color:#ccc; padding:15px; border-radius:10px; width:280px; text-align:left; border:1px solid #333;"></div>
        </div>
    </div>

    <div id="music-btn" onclick="toggleMusic()" title="Play/Pause Background Music">
        <svg id="icon-play" viewBox="0 0 24 24" style="display:none;"><path d="M8 5v14l11-7z"/></svg>
        <svg id="icon-pause" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
    </div>

    <iframe id="sc-widget" width="100%" height="166" scrolling="no" frameborder="no" allow="autoplay"
        src="https://w.soundcloud.com/player/?url=https%3A//soundcloud.com/pildu-yoon&color=%2300ff00&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true">
    </iframe>

    <canvas id="gameCanvas"></canvas>

    <script>
        const widget = SC.Widget(document.querySelector('#sc-widget'));
        const musicBtn = document.getElementById('music-btn');
        const iconPlay = document.getElementById('icon-play');
        const iconPause = document.getElementById('icon-pause');
        let isPlaying = false;

        function toggleMusic() {
            widget.toggle();
            isPlaying = !isPlaying;
            updateMusicButton();
        }

        function updateMusicButton() {
            if (isPlaying) {
                iconPlay.style.display = 'none';
                iconPause.style.display = 'block';
                musicBtn.classList.add('music-playing');
            } else {
                iconPlay.style.display = 'block';
                iconPause.style.display = 'none';
                musicBtn.classList.remove('music-playing');
            }
        }

        widget.bind(SC.Widget.Events.PLAY, function() {
            isPlaying = true;
            updateMusicButton();
        });

        widget.bind(SC.Widget.Events.PAUSE, function() {
            isPlaying = false;
            updateMusicButton();
        });

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height, centerX, centerY;
        
        let gameState = "START";
        let score = 0;
        let frameCount = 0;
        let lastItemPickupTime = 0;
        
        // Ben P. Miller
        const SEG_RADIUS = 16;
        const SEG_DIST = 18;
        let caterpillar = [];
        let mouseX = 0, mouseY = 0;
        let caterpillarSpeed = 0;

        // Entities
        let enemies = [];
        let items = [];
        let particles = [];
        let projectiles = []; 
        let orbitNotes = [];  

        // Effect Timers
        let effectTimers = {
            shooter: 0,
            orbit: 0,
            barrier: 0,
            laser: 0
        };

        const ENEMY_TYPES = [
            { icon: '‚ö°', label: 'Noise' },
            { icon: 'üí¢', label: 'Stress' },
            { icon: '‚òÅÔ∏è', label: 'Doubt' },
            { icon: 'üí§', label: 'Fatigue' }
        ];

        // ÏïÑÏù¥ÌÖú Ï†ïÏùò (Î†àÎ≤®Î≥Ñ ÌôïÎ•†: Í∞Å Î†àÎ≤®ÏùÄ Ïù¥Ï†Ñ Î†àÎ≤®Ïùò 50%)
        const ITEMS = {
            // Level 1: Í∞ÄÏû• ÌùîÌï® (weight 100)
            SHOOTER: { icon: 'üíø', color: '#ff00ff', label: 'Vinyl Shooter',  unlock: 0,    weight: 100, duration: 1600, life: 2400, level: 1 },

            // Level 2: Level 1Ïùò 50% (weight 50)
            LASER:   { icon: '‚ö°', color: '#ffff00', label: 'Laser Beam',     unlock: 500,  weight: 50, duration: 1600, life: 2400, level: 2 },
            PIANO:   { icon: 'üéπ', color: '#ffffff', label: 'Piano Road',     unlock: 1000, weight: 50, duration: 0,    life: 2400, level: 2 },

            // Level 3: Level 2Ïùò 50% (weight 25)
            ORBIT:   { icon: 'üéµ', color: '#55ff55', label: 'Melody Orbit',   unlock: 1500, weight: 25, duration: 600, life: 2400, level: 3 },

            // Level 4: Level 3Ïùò 50% (weight 12-13)
            CHORD:   { icon: 'üì∂', color: '#ffaa00', label: 'Power Chord',    unlock: 2500, weight: 13, duration: 0,   life: 2400, level: 4 },
            FIELD:   { icon: 'üõ°Ô∏è', color: '#00ffaa', label: 'Force Field',    unlock: 3000, weight: 12, duration: 600, life: 2400, level: 4 },
            WAVE:    { icon: 'üìÄ', color: '#00ffff', label: 'Sound Ball',     unlock: 3500, weight: 12, duration: 0,   life: 2400, level: 4 },

            // Level 5: Level 4Ïùò 50% (weight 6)
            BOMB:    { icon: 'üí£', color: '#ff5555', label: 'Bass Drop',      unlock: 5000, weight: 6,  duration: 0,   life: 2400, level: 5 }
        };

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            centerX = width/2; centerY = height/2;
            if(gameState === "START") {
                mouseX = centerX; mouseY = centerY;
                initCaterpillar(centerX, centerY);
            }
        }
        window.addEventListener('resize', resize);
        window.addEventListener('mousemove', e => { mouseX = e.clientX; mouseY = e.clientY; });

        function initCaterpillar(x, y) {
            caterpillar = [];
            for(let i=0; i<6; i++) caterpillar.push({ x: x, y: y + i*SEG_DIST, angle: 0 });
        }

        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-over-screen').style.display = 'none';
            gameState = 'PLAYING';
            score = 0;
            frameCount = 0;
            updateScore();

            enemies = []; items = []; particles = [];
            projectiles = []; orbitNotes = [];

            for(let k in effectTimers) effectTimers[k] = 0;

            initCaterpillar(centerX, centerY);

            // Í≤åÏûÑ ÏãúÏûë Ïãú Ï¥àÍ∏∞ ÏïÑÏù¥ÌÖú 2Í∞ú Ïä§Ìè∞
            spawnInitialItems();

            if (!isPlaying) {
                widget.play();
                isPlaying = true;
                updateMusicButton();
            }
            requestAnimationFrame(gameLoop);
        }

        function spawnInitialItems() {
            // ÏãúÏûë Ïãú 1Í∞úÏùò ÏïÑÏù¥ÌÖúÏùÑ ÌôîÎ©¥ Ï§ëÏïô Í∑ºÏ≤òÏóê Î∞∞Ïπò
            items.push({
                x: centerX + (Math.random()-0.5)*200,
                y: centerY + (Math.random()-0.5)*200,
                type: 'SHOOTER',
                data: ITEMS.SHOOTER,
                radius: 28,
                pulse: 0,
                life: ITEMS.SHOOTER.life,
                maxLife: ITEMS.SHOOTER.life
            });
        }

        function endGame() {
            gameState = 'GAMEOVER';
            createExplosion(caterpillar[0].x, caterpillar[0].y, '#55ff55', 80);
            document.getElementById('final-score').innerText = score;
            document.getElementById('game-over-screen').style.display = 'block';
            loadRank();
        }

        function saveRecord() {
            let name = document.getElementById('player-name').value || "Anonymous";
            let list = JSON.parse(localStorage.getItem('bulletRank')) || [];
            list.push({n: name, s: score});
            list.sort((a, b) => b.s - a.s);
            list = list.slice(0, 5);
            localStorage.setItem('bulletRank', JSON.stringify(list));
        }

        function saveAndPlayAgain() {
            saveRecord();
            startGame();
        }

        function loadRank() {
            let list = JSON.parse(localStorage.getItem('bulletRank')) || [];
            let html = "<b>üèÜ Hall of Fame</b><br><br>";
            list.forEach((r, i) => html += `<div>${i+1}. ${r.n} : ${r.s}</div>`);
            document.getElementById('rank-box').innerHTML = html;
        }

        function updateScore() {
            document.getElementById('score').innerText = score;
        }

        function showStatus(text, color) {
            const el = document.getElementById('status-msg');
            el.innerText = text; el.style.color = color; el.style.textShadow = `0 0 30px ${color}`;
            el.style.display = 'block'; 
            el.animate([
                { transform: 'translateX(-50%) scale(0.5)', opacity: 0 },
                { transform: 'translateX(-50%) scale(1.2)', opacity: 1, offset: 0.2 },
                { transform: 'translateX(-50%) scale(1)', opacity: 1, offset: 0.8 },
                { transform: 'translateX(-50%) scale(1.5)', opacity: 0, offset: 1 }
            ], { duration: 1500, fill: 'forwards' });
        }

        function spawnLoop() {
            if (gameState !== 'PLAYING') return;

            // 1. Ï†Å ÏµúÎåÄ Í∞úÏ≤¥ Ïàò: Í∏∞Î≥∏ 60 + 10,000Ï†êÎãπ 10Í∞ú Ï¶ùÍ∞Ä
            const baseEnemies = 60;
            const bonusEnemies = Math.floor(score / 10000) * 10;
            const maxEnemies = baseEnemies + bonusEnemies;

            // 2. Ïä§Ìè∞ ÏÜçÎèÑ: Í∏∞Ï°¥Í≥º ÎèôÏùºÌïòÍ≤å Ïú†ÏßÄ
            const spawnRate = Math.max(3, 8 - Math.floor(score/1000));

            if (enemies.length < maxEnemies && frameCount % spawnRate === 0) {
                // 3. Burst Spawn: Í∏∞Î≥∏ 1 + 20,000Ï†êÎãπ 1ÎßàÎ¶¨Ïî© Ï¶ùÍ∞Ä
                const count = 1 + Math.floor(score / 20000);

                for(let i=0; i<count; i++) {
                    let angle;
                    // 4. Îì±Ïû• Î∞©Ìñ•: 100,000Ï†ê Îã®ÏúÑÎ°ú Î≥ÄÍ≤Ω
                    if (score < 100000) {
                        // Phase 1 (0 ~ 10Îßå): ÏúÑÏ™Ω 90ÎèÑ Î≤îÏúÑ
                        angle = -Math.PI/2 + (Math.random()-0.5) * Math.PI/2;
                    } else if (score < 200000) {
                        // Phase 2 (10Îßå ~ 20Îßå): ÏúÑÏ™Ω + ÏñëÏòÜ 180ÎèÑ Î≤îÏúÑ
                        angle = -Math.PI/2 + (Math.random()-0.5) * Math.PI;
                    } else {
                        // Phase 3 (20Îßå ~): Ï†ÑÎ∞©Ìñ• 360ÎèÑ
                        angle = Math.random() * Math.PI * 2;
                    }

                    const dist = Math.max(width, height) * 0.8; 
                    const head = caterpillar[0];
                    const tx = head.x + (Math.random()-0.5)*200;
                    const ty = head.y + (Math.random()-0.5)*200;

                    const sx = centerX + Math.cos(angle)*dist;
                    const sy = centerY + Math.sin(angle)*dist;
                    const moveAngle = Math.atan2(ty-sy, tx-sx);
                    
                    const typeData = ENEMY_TYPES[Math.floor(Math.random() * ENEMY_TYPES.length)];

                    enemies.push({
                        x: sx, y: sy,
                        vx: Math.cos(moveAngle), vy: Math.sin(moveAngle),
                        speed: ((1.5 + Math.random()*1.5) * 0.8), 
                        radius: 25 + Math.random()*15, 
                        typeData: typeData,
                        rotation: Math.random() * Math.PI,
                        spinSpeed: (Math.random()-0.5) * 0.05
                    });
                }
            }

            const timeSinceLastPickup = frameCount - lastItemPickupTime;
            const spawnInterval = (lastItemPickupTime > 0 && timeSinceLastPickup < 900) ? 450 : 900; // 15Ï¥à Í∏∞Î≥∏, ÌöçÎìù ÌõÑ 7.5Ï¥à 

            if (frameCount % spawnInterval === 0 && items.length < 3) {
                const available = Object.keys(ITEMS).filter(k => score >= ITEMS[k].unlock);
                let totalWeight = 0;
                available.forEach(k => totalWeight += ITEMS[k].weight);
                let rand = Math.random() * totalWeight;
                let selectedKey = 'SHOOTER';
                for(let k of available) {
                    if (rand < ITEMS[k].weight) { selectedKey = k; break; }
                    rand -= ITEMS[k].weight;
                }

                items.push({
                    x: 50 + Math.random()*(width-100),
                    y: 50 + Math.random()*(height-100),
                    type: selectedKey,
                    data: ITEMS[selectedKey],
                    radius: 28, pulse: 0,
                    life: ITEMS[selectedKey].life,
                    maxLife: ITEMS[selectedKey].life
                });
            }
        }

        function activateItem(type) {
            const data = ITEMS[type];
            showStatus(data.label, data.color);
            score += 300;

            switch(type) {
                case 'SHOOTER':
                    effectTimers.shooter = data.duration;
                    effectTimers.laser = 0; // Î†àÏù¥Ï†Ä ÎπÑÌôúÏÑ±Ìôî
                    break;
                case 'ORBIT':
                    effectTimers.orbit = data.duration;
                    orbitNotes = [];
                    for(let i=0; i<6; i++) orbitNotes.push({ angle: (Math.PI*2/6)*i });
                    break;
                case 'WAVE':
                    fireSoundBall();
                    break;
                case 'PIANO':
                    firePiano();
                    break;
                case 'LASER':
                    effectTimers.laser = data.duration;
                    effectTimers.shooter = 0; // Î∞îÏù¥Îãê ÏäàÌÑ∞ ÎπÑÌôúÏÑ±Ìôî
                    break;
                case 'CHORD':
                    fireWifiWave();
                    break;
                case 'FIELD':
                    effectTimers.barrier = data.duration;
                    break;
                case 'BOMB':
                    enemies.forEach(e => createExplosion(e.x, e.y, '#ff5555', 8));
                    enemies = [];
                    break;
            }
        }

        function fireVinyl() {
            const head = caterpillar[0];
            const angle = head.angle;
            projectiles.push({
                type: 'VINYL',
                x: head.x, y: head.y,
                vx: Math.cos(angle)*3.33, vy: Math.sin(angle)*3.33,
                radius: 12, life: 360, color: '#ff00ff'
            });
        }

        function fireSoundBall() {
            const head = caterpillar[0];
            const angle = head.angle;
            const ballSpeed = Math.max(caterpillarSpeed * 1.5, 4.0);

            projectiles.push({
                type: 'BALL',
                x: head.x, y: head.y,
                vx: Math.cos(angle)*ballSpeed, vy: Math.sin(angle)*ballSpeed,
                radius: 117, life: 600, color: '#00ffff', rotation: 0 // ÌÅ¨Í∏∞ 2/3Î°ú Ï∂ïÏÜå (175 -> 117)
            });
        }

        function fireWifiWave() {
            const head = caterpillar[0];
            const maxR = Math.max(width, height) * 1.5;
            projectiles.push({
                type: 'WIFI',
                x: head.x, y: head.y,
                angle: head.angle,
                currentRadius: 10,
                maxRadius: maxR,
                spread: Math.PI * 0.66, 
                life: 600, color: '#ffaa00'
            });
        }

        function firePiano() {
            const head = caterpillar[0];
            // ÏàòÏßÅÏúºÎ°ú ÏúÑÎ°ú Ïò¨ÎùºÍ∞ê
            const speed = 1.0;

            projectiles.push({
                type: 'PIANO',
                x: head.x, y: head.y,
                vx: 0, vy: -speed, // ÏúÑÎ°ú ÏàòÏßÅ Ïù¥Îèô
                width: width / 7, // ÏàòÌèâ Í∏∏Ïù¥
                height: 60, // ÏàòÏßÅ ÎÜíÏù¥
                angle: 0, // Ìï≠ÏÉÅ ÏàòÌèâ (0ÎèÑ)
                life: 800, color: '#ffffff'
            });
        }

        function fireLaser() {
            const head = caterpillar[0];
            const angle = head.angle;
            const speed = 15; // Îß§Ïö∞ Îπ†Î•∏ ÏÜçÎèÑ

            projectiles.push({
                type: 'LASER',
                x: head.x, y: head.y,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed,
                angle: angle,
                width: 4, // Í¥ëÏÑ† ÎëêÍªò
                length: 60, // Í¥ëÏÑ† Í∏∏Ïù¥
                life: 120, // 2Ï¥à (120ÌîÑÎ†àÏûÑ)
                color: '#ffff00'
            });
        }

        function createExplosion(x, y, color, count) {
            const reducedCount = enemies.length > 80 ? Math.min(count, 3) : count;
            for(let i=0; i<reducedCount; i++) {
                particles.push({
                    x: x, y: y,
                    vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                    life: 1.0, color: color, size: Math.random()*5+2
                });
            }
        }

        function gameLoop() {
            if (gameState !== 'PLAYING') return;
            frameCount++;
            ctx.clearRect(0, 0, width, height);

            spawnLoop();

            // 1. Ìö®Í≥º ÌÉÄÏù¥Î®∏
            if (effectTimers.shooter > 0) {
                effectTimers.shooter--;
                if (frameCount % 13 === 0) fireVinyl();
            }
            if (effectTimers.laser > 0) {
                effectTimers.laser--;
                if (frameCount % 10 === 0) fireLaser(); // 0.16Ï¥àÎßàÎã§ Î∞úÏÇ¨
            }
            if (effectTimers.orbit > 0) effectTimers.orbit--;
            if (effectTimers.barrier > 0) effectTimers.barrier--;

            // 2. Î∞úÏÇ¨Ï≤¥ ÏóÖÎç∞Ïù¥Ìä∏
            for(let i=projectiles.length-1; i>=0; i--) {
                let p = projectiles[i];
                let hitEnemy = false;

                // --- PIANO ---
                if (p.type === 'PIANO') {
                    p.x += p.vx; p.y += p.vy; p.life--;
                    
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.angle);
                    
                    // ÌîºÏïÑÎÖ∏ Í±¥Î∞ò Í∑∏Î¶¨Í∏∞
                    ctx.fillStyle = 'rgba(255,255,255,0.9)';
                    const w = p.width; const h = p.height;
                    // Í±¥Î∞ò Î∞îÎîî
                    ctx.fillRect(-w/2, -h/2, w, h);
                    // Í≤ÄÏùÄ Í±¥Î∞ò
                    ctx.fillStyle = 'black';
                    for(let k=-2; k<=2; k++) {
                        if(k!==0) ctx.fillRect(k*(w/6) - 5, -h/2, 10, h*0.6);
                    }
                    // Ïï†ÎãàÎ©îÏù¥ÏÖò Ìö®Í≥º
                    if (Math.floor(frameCount/10)%2===0) {
                        ctx.strokeStyle = 'white'; ctx.lineWidth=4;
                        ctx.strokeRect(-w/2, -h/2, w, h);
                    }
                    ctx.restore();

                    // Ï∂©Îèå Ï≤¥ÌÅ¨ (Rect vs Circle - Í∞ÑÎã®Ìûà Í±∞Î¶¨Î°ú Í∑ºÏÇ¨)
                    for(let j=enemies.length-1; j>=0; j--) {
                        let e = enemies[j];
                        // Îã®Ïàú Í±∞Î¶¨ Ï≤¥ÌÅ¨ (ÎÑàÎπÑ/2 + Ï†ÅÎ∞òÍ≤Ω)
                        if (Math.hypot(e.x - p.x, e.y - p.y) < w/2 + e.radius) {
                            enemies.splice(j, 1);
                            createExplosion(e.x, e.y, '#ffffff', 5);
                            score += 50;
                        }
                    }
                    
                    // ÌôîÎ©¥ Î∞ñ Î©ÄÎ¶¨ ÎÇòÍ∞ÄÎ©¥ ÏÇ≠Ï†ú
                    if (p.life <= 0 || p.x < -200 || p.x > width+200 || p.y < -200 || p.y > height+200) {
                        projectiles.splice(i, 1);
                    }
                    continue;
                }

                // --- LASER ---
                if (p.type === 'LASER') {
                    p.x += p.vx; p.y += p.vy; p.life--;

                    // Î†àÏù¥Ï†Ä Îπî Í∑∏Î¶¨Í∏∞
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.angle);

                    // Ïô∏Í≥Ω Í∏ÄÎ°úÏö∞
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = p.color;
                    ctx.strokeStyle = p.color;
                    ctx.lineWidth = p.width + 4;
                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    ctx.lineTo(p.length, 0);
                    ctx.stroke();

                    // ÎÇ¥Î∂Ä Î∞ùÏùÄ Îπî
                    ctx.shadowBlur = 0;
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = p.width;
                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    ctx.lineTo(p.length, 0);
                    ctx.stroke();
                    ctx.restore();

                    // Î†àÏù¥Ï†Ä Í≤ΩÎ°ú ÏÉÅÏùò Î™®Îì† Ï†Å Ï†úÍ±∞ (Í¥ÄÌÜµ)
                    for(let j=enemies.length-1; j>=0; j--) {
                        let e = enemies[j];
                        // Î†àÏù¥Ï†Ä ÏãúÏûëÏ†êÏóêÏÑú ÎÅùÏ†êÍπåÏßÄÏùò ÏÑ†Î∂ÑÍ≥º Ï†ÅÏùò Ï∂©Îèå Ï≤¥ÌÅ¨
                        const laserEndX = p.x + Math.cos(p.angle) * p.length;
                        const laserEndY = p.y + Math.sin(p.angle) * p.length;

                        // Ï†êÍ≥º ÏÑ†Î∂Ñ ÏÇ¨Ïù¥Ïùò Í±∞Î¶¨ Í≥ÑÏÇ∞
                        const dx = laserEndX - p.x;
                        const dy = laserEndY - p.y;
                        const len = Math.hypot(dx, dy);
                        const dotProduct = ((e.x - p.x) * dx + (e.y - p.y) * dy) / (len * len);
                        const closestX = p.x + dotProduct * dx;
                        const closestY = p.y + dotProduct * dy;

                        // ÏÑ†Î∂Ñ Î≤îÏúÑ ÎÇ¥Ïóê ÏûàÎäîÏßÄ Ï≤¥ÌÅ¨
                        if (dotProduct >= 0 && dotProduct <= 1) {
                            const dist = Math.hypot(e.x - closestX, e.y - closestY);
                            if (dist < e.radius + p.width) {
                                enemies.splice(j, 1);
                                createExplosion(e.x, e.y, p.color, 8);
                                score += 50;
                            }
                        }
                    }

                    // ÌôîÎ©¥ Î∞ñ ÎÇòÍ∞ÄÎ©¥ ÏÇ≠Ï†ú
                    if (p.life <= 0 || p.x < -200 || p.x > width+200 || p.y < -200 || p.y > height+200) {
                        projectiles.splice(i, 1);
                    }
                    continue;
                }

                // --- WIFI ---
                if (p.type === 'WIFI') {
                    p.currentRadius += 2; 
                    p.life--;
                    
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    const alpha = Math.max(0, p.life/100);
                    ctx.lineWidth = 10;
                    ctx.strokeStyle = `rgba(255, 170, 0, ${alpha})`;
                    for(let r=0; r<3; r++) {
                        const waveR = p.currentRadius - (r*30);
                        if(waveR > 0) {
                            ctx.beginPath();
                            ctx.arc(0, 0, waveR, p.angle - p.spread/2, p.angle + p.spread/2);
                            ctx.stroke();
                        }
                    }
                    ctx.restore();

                    for(let j=enemies.length-1; j>=0; j--) {
                        let e = enemies[j];
                        const dx = e.x - p.x; const dy = e.y - p.y;
                        const dist = Math.hypot(dx, dy);
                        const angleToEnemy = Math.atan2(dy, dx);
                        let angleDiff = angleToEnemy - p.angle;
                        while (angleDiff <= -Math.PI) angleDiff += Math.PI*2;
                        while (angleDiff > Math.PI) angleDiff -= Math.PI*2;

                        if (dist < p.currentRadius && Math.abs(angleDiff) < p.spread/2) {
                             enemies.splice(j, 1);
                             createExplosion(e.x, e.y, p.color, 6);
                             score += 50;
                        }
                    }
                    if (p.life <= 0 || p.currentRadius > p.maxRadius) projectiles.splice(i, 1);
                    continue; 
                }

                // --- BALL & VINYL ---
                p.x += p.vx; p.y += p.vy; p.life--;

                if (p.type === 'BALL') {
                    // ÏàòÎ™ÖÏù¥ ÎÇ®ÏïòÏùÑ ÎïåÎßå ÌäïÍπÄ
                    if (p.life > 0) {
                        if (p.x < p.radius || p.x > width - p.radius) p.vx *= -1;
                        if (p.y < p.radius || p.y > height - p.radius) p.vy *= -1;
                    }
                    // ÏàòÎ™Ö ÎÅùÎÇòÎ©¥ Î≤Ω ÌÜµÍ≥º (Fadeout)
                    let alpha = 1.0;
                    if (p.life <= 0) {
                        alpha = 0.5; // ÏÇ¨ÎùºÏßÄÎäî Ï§ë
                    }

                    p.rotation += 0.1;
                    ctx.save(); 
                    ctx.translate(p.x, p.y); 
                    ctx.rotate(p.rotation);
                    ctx.globalAlpha = alpha;
                    
                    ctx.fillStyle = '#111'; ctx.beginPath(); ctx.arc(0, 0, p.radius, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(0, 0, p.radius*0.4, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle = '#050a05'; ctx.beginPath(); ctx.arc(0, 0, p.radius*0.1, 0, Math.PI*2); ctx.fill();
                    ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(0, 0, p.radius*0.7, 0, Math.PI*2); ctx.stroke();
                    ctx.restore();
                    
                    // ÌôîÎ©¥ Î∞ñÏúºÎ°ú ÏôÑÏ†ÑÌûà ÎÇòÍ∞ÄÎ©¥ ÏÇ≠Ï†ú
                    if (p.life <= 0 && (p.x < -p.radius || p.x > width+p.radius || p.y < -p.radius || p.y > height+p.radius)) {
                        projectiles.splice(i, 1);
                        continue;
                    }
                } 
                else if (p.type === 'VINYL') {
                    ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(frameCount * 0.2); 
                    ctx.fillStyle = '#111'; ctx.beginPath(); ctx.arc(0, 0, p.radius, 0, Math.PI*2); ctx.fill();
                    ctx.strokeStyle = p.color; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(0, 0, p.radius*0.6, 0, Math.PI*2); ctx.stroke();
                    ctx.restore();
                }

                // Ï†Å Ï∂©Îèå (BALL & VINYL)
                for(let j=enemies.length-1; j>=0; j--) {
                    let e = enemies[j];
                    if (Math.hypot(e.x - p.x, e.y - p.y) < e.radius + p.radius) {
                        enemies.splice(j, 1);
                        createExplosion(e.x, e.y, p.color, 10);
                        score += 50;
                        if (p.type === 'VINYL') { hitEnemy = true; break; }
                        // BALLÏùÄ Í¥ÄÌÜµ
                    }
                }

                if ((p.type === 'VINYL' && hitEnemy) || (p.type === 'VINYL' && p.life <= 0) || 
                    (p.type === 'VINYL' && (p.x<0||p.x>width||p.y<0||p.y>height))) {
                    projectiles.splice(i, 1);
                }
            }

            // 3. Ï†Å Ï≤òÎ¶¨
            const useEffects = enemies.length < 50;
            for(let i=enemies.length-1; i>=0; i--) {
                let e = enemies[i];
                e.x += e.vx * e.speed; e.y += e.vy * e.speed; e.rotation += e.spinSpeed;

                if (e.x < -1000 || e.x > width+1000 || e.y < -1000 || e.y > height+1000) {
                     enemies.splice(i, 1); continue;
                }

                ctx.save(); ctx.translate(e.x, e.y); ctx.rotate(e.rotation);
                ctx.fillStyle = '#d32f2f';
                if (useEffects) { ctx.shadowBlur = 10; ctx.shadowColor = '#d32f2f'; }
                ctx.beginPath();
                const spikes = 12;
                for(let k=0; k<spikes*2; k++) {
                    const r = k%2===0 ? e.radius : e.radius * 0.6;
                    const a = (Math.PI*2 * k) / (spikes*2);
                    ctx.lineTo(r*Math.cos(a), r*Math.sin(a));
                }
                ctx.closePath(); ctx.fill();
                if (useEffects) ctx.shadowBlur = 0;
                ctx.rotate(-e.rotation);
                ctx.fillStyle = '#fff'; ctx.font = "20px Segoe UI Emoji"; 
                ctx.textAlign = "center"; ctx.textBaseline = "middle";
                ctx.fillText(e.typeData.icon, 0, 2);
                ctx.restore();

                let isDead = false;

                if (effectTimers.orbit > 0) {
                    const head = caterpillar[0];
                    const orbitR = 80; 
                    orbitNotes.forEach(note => {
                        const nx = head.x + Math.cos(note.angle + frameCount*0.1) * orbitR;
                        const ny = head.y + Math.sin(note.angle + frameCount*0.1) * orbitR;
                        if (Math.hypot(nx - e.x, ny - e.y) < 25 + e.radius) {
                            isDead = true; 
                            createExplosion(e.x, e.y, '#55ff55', 10);
                        }
                    });
                }

                if (!isDead && effectTimers.barrier > 0) {
                    const head = caterpillar[0];
                    // Ìè¨Ïä§ÌïÑÎìú ÌÅ¨Í∏∞ Ï¶ùÍ∞Ä: 70 -> 120 (Ï†ÑÏ≤¥ Ïª§Î≤Ñ)
                    if (Math.hypot(head.x - e.x, head.y - e.y) < 120 + e.radius) {
                        isDead = true; 
                        createExplosion(e.x, e.y, '#00ffaa', 10);
                    }
                }

                if (!isDead) {
                    for(let p of caterpillar) {
                        if (Math.hypot(p.x - e.x, p.y - e.y) < SEG_RADIUS + e.radius - 8) {
                            endGame(); return;
                        }
                    }
                }

                if (isDead) { enemies.splice(i, 1); score += 50; }
            }

            // 4. ÏïÑÏù¥ÌÖú Ï≤òÎ¶¨
            for(let i=items.length-1; i>=0; i--) {
                let item = items[i];
                item.life--;
                if (item.life <= 0) { items.splice(i, 1); continue; }
                if (item.life < 180 && Math.floor(frameCount/5)%2===0) continue; 

                item.pulse += 0.05;
                const scale = 1 + Math.sin(item.pulse)*0.1;
                ctx.save(); ctx.translate(item.x, item.y); ctx.scale(scale, scale);
                ctx.shadowBlur = 20; ctx.shadowColor = item.data.color;
                ctx.fillStyle = item.data.color;
                ctx.beginPath(); ctx.arc(0, 0, item.radius, 0, Math.PI*2); ctx.fill();
                ctx.shadowBlur = 0;
                ctx.fillStyle = '#000';
                ctx.font = "24px Segoe UI Emoji"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                ctx.fillText(item.data.icon, 0, 2);
                ctx.restore();

                if (Math.hypot(caterpillar[0].x - item.x, caterpillar[0].y - item.y) < SEG_RADIUS + item.radius) {
                    activateItem(item.type);
                    items.splice(i, 1);
                    lastItemPickupTime = frameCount;
                }
            }

            // 5. Ben & Ìö®Í≥º Í∑∏Î¶¨Í∏∞
            if (effectTimers.barrier > 0) {
                const head = caterpillar[0];
                ctx.save();
                ctx.translate(head.x, head.y);
                ctx.rotate(frameCount * 0.02);
                ctx.strokeStyle = `rgba(0, 255, 170, ${0.3 + Math.sin(frameCount*0.1)*0.2})`;
                ctx.lineWidth = 4;
                ctx.shadowBlur = 20; ctx.shadowColor = '#00ffaa';
                
                // Î≥¥Ìò∏Îßâ ÌÅ¨Í∏∞ Ï¶ùÍ∞Ä (110)
                ctx.beginPath();
                for(let i=0; i<6; i++) {
                    const angle = i * Math.PI/3;
                    const r = 110; 
                    ctx.lineTo(Math.cos(angle)*r, Math.sin(angle)*r);
                }
                ctx.closePath(); ctx.stroke();
                ctx.fillStyle = 'rgba(0, 255, 170, 0.1)'; ctx.fill();
                ctx.restore();
            }

            if (effectTimers.orbit > 0) {
                const head = caterpillar[0];
                const orbitR = 80;
                ctx.font = "24px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                orbitNotes.forEach(note => {
                    const ang = note.angle + frameCount*0.1;
                    const nx = head.x + Math.cos(ang) * orbitR;
                    const ny = head.y + Math.sin(ang) * orbitR;
                    ctx.shadowBlur = 10; ctx.shadowColor = '#55ff55';
                    ctx.fillText("üéµ", nx, ny);
                    ctx.shadowBlur = 0;
                });
            }

            const head = caterpillar[0];
            const dx = mouseX - head.x; const dy = mouseY - head.y;
            const dist = Math.hypot(dx, dy);
            const speed = 5;
            if (dist > speed) {
                const angle = Math.atan2(dy, dx);
                head.x += Math.cos(angle) * speed;
                head.y += Math.sin(angle) * speed;
                head.angle = angle;
                caterpillarSpeed = speed;
            } else { caterpillarSpeed = dist; }

            for(let i=1; i<caterpillar.length; i++) {
                const cur = caterpillar[i]; const prev = caterpillar[i-1];
                const dx2 = prev.x - cur.x; const dy2 = prev.y - cur.y;
                const d2 = Math.hypot(dx2, dy2); const a2 = Math.atan2(dy2, dx2);
                if (d2 > SEG_DIST) {
                    const m = d2 - SEG_DIST;
                    cur.x += Math.cos(a2) * m * 0.6; cur.y += Math.sin(a2) * m * 0.6;
                    cur.angle = a2;
                }
            }

            for(let i=caterpillar.length-1; i>=0; i--) {
                const p = caterpillar[i];
                ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.angle);
                if (i===0) { 
                    ctx.fillStyle = '#66BB6A'; 
                    ctx.beginPath(); ctx.arc(0, 0, SEG_RADIUS+2, 0, Math.PI*2); ctx.fill();
                    ctx.strokeStyle = '#111'; ctx.lineWidth = 3; ctx.fillStyle = 'rgba(255,255,255,0.6)';
                    ctx.beginPath(); ctx.arc(7, -6, 6, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                    ctx.beginPath(); ctx.arc(7, 6, 6, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(7, -6); ctx.lineTo(7, 6); ctx.stroke();
                } else {
                    ctx.fillStyle = i%2===0 ? '#4CAF50' : '#43A047';
                    ctx.beginPath(); ctx.arc(0, 0, SEG_RADIUS, 0, Math.PI*2); ctx.fill();
                }
                ctx.restore();
            }

            if (particles.length > 200) particles = particles.slice(-200);
            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i];
                p.x += p.vx; p.y += p.vy; p.life -= 0.04;
                ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1.0;
                if(p.life <= 0) particles.splice(i, 1);
            }

            updateScore();
            requestAnimationFrame(gameLoop);
        }

        resize();
    </script>
</body>
</html>