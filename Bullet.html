<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Void Perimeter - Stephen Edition (Fixed)</title>
    <script src="https://w.soundcloud.com/player/api.js"></script>
    <style>
        body { margin: 0; background: #050510; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; user-select: none; }
        canvas { display: block; cursor: none; } /* 커서 숨김 */
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .hud-text { 
            position: absolute; 
            color: #00faff; 
            text-shadow: 0 0 10px #00faff; 
            font-size: 20px; font-weight: bold; letter-spacing: 2px; 
            margin: 20px;
        }
        #hud-time { top: 0; left: 0; }
        #hud-best { top: 0; right: 0; }

        .center-msg {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: auto;
            cursor: pointer;
        }
        
        h1 { color: #ff3366; font-size: 60px; margin: 0; text-transform: uppercase; text-shadow: 0 0 20px #ff0000; }
        p { color: white; font-size: 18px; margin-top: 10px; opacity: 0.8; line-height: 1.5; }
        .blink { color: #00faff; margin-top: 30px; animation: blink 1s infinite; font-weight: bold; }

        #start-screen { display: block; }
        #game-over-screen { display: none; }

        /* Stephenyoon.com 스타일 버튼 */
        #music-btn {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background-color: #00D365;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            cursor: pointer;
            pointer-events: auto;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
        }
        #music-btn:active { transform: scale(0.95); }
        
        .icon-play {
            width: 0; height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 14px solid white;
            margin-left: 4px;
        }
        .icon-pause {
            width: 12px; height: 16px;
            border-left: 4px solid white;
            border-right: 4px solid white;
        }

        #sc-widget { display: none; }
        
        .scanlines {
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 5;
        }
    </style>
</head>
<body>

    <div class="scanlines"></div>

    <div id="ui-layer">
        <div id="hud-time" class="hud-text">TIME: <span id="score">0.00</span>s</div>
        <div id="hud-best" class="hud-text">BEST: <span id="best">0.00</span>s</div>
        
        <div id="start-screen" class="center-msg" onclick="startGame()">
            <h1>VOID PERIMETER</h1>
            <p>Move mouse to control ship.</p>
            <p>Stay inside the Red Circle.</p>
            <p class="blink">CLICK TO START & MUSIC</p>
        </div>

        <div id="game-over-screen" class="center-msg" onclick="resetGame()">
            <h1>CRITICAL FAILURE</h1>
            <p>Survival Time: <span id="final-score">0</span>s</p>
            <p class="blink">CLICK TO RETRY</p>
        </div>
    </div>

    <div id="music-btn" onclick="toggleMusic()">
        <div id="music-icon" class="icon-play"></div>
    </div>

    <iframe id="sc-widget" width="100%" height="166" scrolling="no" frameborder="no" allow="autoplay"
        src="https://w.soundcloud.com/player/?url=https%3A//soundcloud.com/pildu-yoon&color=%2300ff00&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true">
    </iframe>

    <canvas id="gameCanvas"></canvas>

    <script>
        // --- SoundCloud 설정 ---
        const iframeElement = document.querySelector('#sc-widget');
        const widget = SC.Widget(iframeElement);
        const musicIcon = document.getElementById('music-icon');
        let isPlaying = false;

        function toggleMusic() {
            widget.toggle();
            isPlaying = !isPlaying;
            updateMusicIcon();
        }

        function updateMusicIcon() {
            musicIcon.className = isPlaying ? 'icon-pause' : 'icon-play';
        }

        // --- 게임 설정 ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let gameState = "START"; 
        let width, height, centerX, centerY;
        let boundaryRadius = 250;
        let score = 0;
        let highScore = localStorage.getItem('void_best') || 0;
        let startTime = 0;
        let difficultyMultiplier = 1;

        // 플레이어 & 마우스 타겟
        // targetX, targetY는 마우스의 실제 위치
        // player.x, player.y는 우주선의 현재 위치 (마우스를 따라감)
        const player = { x: 0, y: 0, angle: 0, hitbox: 4 };
        let targetX = 0;
        let targetY = 0;
        
        let bullets = [];
        let particles = [];
        let stars = [];

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            centerX = width / 2;
            centerY = height / 2;
            boundaryRadius = Math.min(width, height) * 0.35; 
            // 초기 위치 중앙 설정
            if (gameState === "START") {
                player.x = centerX; player.y = centerY;
                targetX = centerX; targetY = centerY;
            }
        }
        window.addEventListener('resize', resize);
        resize();
        document.getElementById('best').innerText = parseFloat(highScore).toFixed(2);

        // --- 마우스 이벤트 (수정됨: 언제든지 움직임 반영) ---
        window.addEventListener('mousemove', (e) => {
            // 마우스 위치만 업데이트하고, 실제 우주선 이동은 update() 루프에서 처리 (부드러운 움직임 위함)
            
            let rawX = e.clientX;
            let rawY = e.clientY;

            // 원형 경계선(Circle of Fire) 체크
            const dx = rawX - centerX;
            const dy = rawY - centerY;
            const distance = Math.sqrt(dx*dx + dy*dy);
            const angleFromCenter = Math.atan2(dy, dx);

            // 마우스가 원 밖으로 나가면 타겟을 경계선에 고정
            if (distance > boundaryRadius - 15) {
                targetX = centerX + Math.cos(angleFromCenter) * (boundaryRadius - 15);
                targetY = centerY + Math.sin(angleFromCenter) * (boundaryRadius - 15);
            } else {
                targetX = rawX;
                targetY = rawY;
            }
        });

        function initStars() {
            stars = [];
            for(let i=0; i<150; i++) {
                stars.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    size: Math.random() * 2,
                    speed: Math.random() * 0.2 + 0.05
                });
            }
        }

        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            gameState = 'PLAYING';
            startTime = Date.now();
            bullets = [];
            particles = [];
            
            if (!isPlaying) {
                widget.play();
                isPlaying = true;
                updateMusicIcon();
            }
            spawnLoop();
        }

        function resetGame() {
            document.getElementById('game-over-screen').style.display = 'none';
            startGame();
        }

        function createExplosion(x, y, color) {
            for (let i = 0; i < 20; i++) {
                particles.push({
                    x: x, y: y,
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 0.5) * 8,
                    life: 1.0,
                    color: color
                });
            }
        }

        // --- 탄알 생성 ---
        function spawnLoop() {
            if (gameState !== 'PLAYING') return;

            const elapsed = (Date.now() - startTime) / 1000;
            difficultyMultiplier = 1 + (elapsed * 0.1); 

            // 탄알 양 증가 (더 줄임)
            const spawnCount = Math.floor(1 + (difficultyMultiplier * 1.2));

            for(let i=0; i<spawnCount; i++) {
                const angle = Math.random() * Math.PI * 2;
                const spawnDist = boundaryRadius + 150;

                const bx = centerX + Math.cos(angle) * spawnDist;
                const by = centerY + Math.sin(angle) * spawnDist;

                // 플레이어를 정확히 향하도록 수정
                const angleToTarget = Math.atan2(player.y - by, player.x - bx);

                // 탄알 속도 (느리게 시작)
                const baseSpeed = 0.5;
                const speed = (baseSpeed + Math.random() * 0.3) * (difficultyMultiplier * 0.5);

                bullets.push({
                    x: bx, y: by,
                    vx: Math.cos(angleToTarget) * speed,
                    vy: Math.sin(angleToTarget) * speed,
                    radius: 3
                });
            }

            let nextSpawn = Math.max(50, 400 - (elapsed * 10)); 
            setTimeout(spawnLoop, nextSpawn);
        }

        // --- 메인 루프 ---
        function update() {
            // 배경
            ctx.fillStyle = 'rgba(5, 5, 16, 0.4)';
            ctx.fillRect(0, 0, width, height);

            // [중요] 우주선 이동 및 회전 로직 (Easing 적용)
            // 우주선이 타겟(마우스) 위치로 부드럽게 이동 (Lining Interpolation)
            // 이 "지연"이 있어야 우주선이 "바라보는 방향"을 계산할 수 있음
            const ease = 0.15; // 반응 속도 (0.1 ~ 0.3 추천)
            const dx = targetX - player.x;
            const dy = targetY - player.y;
            
            // 위치 업데이트
            player.x += dx * ease;
            player.y += dy * ease;

            // 회전 각도 계산: 우주선이 타겟을 바라보도록 설정
            // 아주 미세한 움직임일 때는 회전하지 않도록 하여 떨림 방지
            if (Math.abs(dx) > 1 || Math.abs(dy) > 1) {
                player.angle = Math.atan2(dy, dx);
            }

            // 별 그리기
            ctx.fillStyle = '#ffffff';
            stars.forEach(star => {
                // 마우스 움직임에 따른 시차 효과
                star.x -= (targetX - centerX) * 0.002 * star.speed;
                star.y -= (targetY - centerY) * 0.002 * star.speed;
                
                if(star.x < 0) star.x += width;
                if(star.x > width) star.x -= width;
                if(star.y < 0) star.y += height;
                if(star.y > height) star.y -= height;

                ctx.globalAlpha = Math.random() * 0.5 + 0.3;
                ctx.fillRect(star.x, star.y, star.size, star.size);
                ctx.globalAlpha = 1.0;
            });

            // 경계선
            ctx.beginPath();
            ctx.arc(centerX, centerY, boundaryRadius, 0, Math.PI * 2);
            ctx.strokeStyle = '#ff3333';
            ctx.lineWidth = 3;
            ctx.shadowBlur = 10 + Math.random() * 20; 
            ctx.shadowColor = '#ff0000';
            ctx.stroke();
            ctx.shadowBlur = 0;

            // 플레이어 그리기 (게임 시작 전에도 보임)
            ctx.save();
            ctx.translate(player.x, player.y);
            ctx.rotate(player.angle);
            
            // 우주선
            ctx.fillStyle = '#00faff';
            ctx.shadowBlur = 15;
            ctx.shadowColor = '#00faff';
            ctx.beginPath();
            ctx.moveTo(15, 0); 
            ctx.lineTo(-10, 8);
            ctx.lineTo(-6, 0);
            ctx.lineTo(-10, -8);
            ctx.fill();
            
            // 히트박스
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(0, 0, player.hitbox, 0, Math.PI*2);
            ctx.fill();
            ctx.restore();

            // 게임 플레이 중 로직
            if (gameState === 'PLAYING') {
                score = (Date.now() - startTime) / 1000;
                document.getElementById('score').innerText = score.toFixed(2);

                for (let i = bullets.length - 1; i >= 0; i--) {
                    let b = bullets[i];
                    b.x += b.vx;
                    b.y += b.vy;

                    ctx.fillStyle = '#ffaa00';
                    ctx.beginPath();
                    ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2);
                    ctx.fill();

                    const distFromCenter = Math.hypot(b.x - centerX, b.y - centerY);
                    if (distFromCenter > boundaryRadius + 400) {
                       bullets.splice(i, 1);
                       continue;
                    }

                    const distToPlayer = Math.hypot(b.x - player.x, b.y - player.y);
                    if (distToPlayer < player.hitbox + b.radius) {
                        endGame();
                    }
                }
            }

            // 파티클
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.05;
                
                ctx.fillStyle = p.color;
                ctx.globalAlpha = p.life;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1.0;

                if (p.life <= 0) particles.splice(i, 1);
            }

            requestAnimationFrame(update);
        }

        function endGame() {
            gameState = 'GAMEOVER';
            createExplosion(player.x, player.y, '#00faff');
            
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('void_best', highScore);
                document.getElementById('best').innerText = highScore.toFixed(2);
            }
            
            document.getElementById('final-score').innerText = score.toFixed(2);
            document.getElementById('game-over-screen').style.display = 'block';
        }

        const styleSheet = document.createElement("style");
        styleSheet.innerText = `@keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }`;
        document.head.appendChild(styleSheet);

        initStars();
        update(); // 게임 루프 시작
    </script>
</body>
</html>